------------------------------------------------------------------------
  
title: "exploitabilite desserte version finale"
author: "Killian BAUE"
contact: "killian.baue@agroparistech.fr"
format: R

df-print: paged
self-contained: true

editor: visual

------------------------------------------------------------------------






## Chargement des librairies necessaires ----
library(happign)
library(tmap)
library(sf)
library(dplyr)
library(terra)
tmap_mode("view")

## Fonction pour importer les donnees cadastrales ----
importer.cadastre <- function(insee_code) {
  # importation des parcelles cadastrales avec le code insee
  get_apicarto_cadastre(
    x = insee_code,                # code insee de la commune
    type = "parcelle",             # type de donnees, ici 'parcelle'
    source = "pci",                # source des donnees 'pci'
    progress = TRUE                # affichage de la progression
  )
}

## Fonction pour importer les routes ----
importer.routes <- function(zone_tampon) {
  # importation des troncons de route dans une zone tampon
  get_wfs(zone_tampon,                        # zone tampon pour la requete WFS
          "BDTOPO_V3:troncon_de_route",       
          spatial_filter = "intersects"       
  )  
}

## Fonction pour re-projeter les donnees spatiales ----
reprojeter.donnees <- function(donnees,
                               code_crs) {
  # Reprojection des donnees spatiales dans le systeme de coordonnees specifie
  st_transform(donnees, crs = code_crs)
}

## Fonction pour filtrer les routes par type ----
filtrer.routes <- function(routes) {
  # Creation des sous-ensembles de routes selon leur nature
  routes_grumiers <- routes %>%
    filter(nature %in% c("Route à 1 chaussée", "Route empierrée"))
  
  routes_skidders <- routes %>%
    filter(nature == "Chemin")
  
  routes_sentiers <- routes %>%
    filter(nature == "Sentier")
  
  list(
    routes_grumiers = routes_grumiers,
    routes_skidders = routes_skidders,
    routes_sentiers = routes_sentiers
  )
}

## Fonction pour verification de l'exploitabilite des pistes ----
verifier.exploitabilite <- function(routes_skidders,
                                    routes_grumiers,
                                    routes_sentiers,
                                    cadastre_2154) {
  # Creation d'un buffer de 5 m autour des routes grumiers
  buffer_grumiers <- st_buffer(routes_grumiers, dist = 5)
  
  # Verification de la connexion directe entre skidders et grumiers
  connexion_directe <- st_intersects(routes_skidders, buffer_grumiers, sparse = FALSE)
  skidders_connectes <- routes_skidders[rowSums(connexion_directe) > 0, ]
  
  skidders_non_connectes <- routes_skidders[rowSums(connexion_directe) == 0, ]
  
  tous_skidders_exploitables <- skidders_connectes
  
  # Boucle pour trouver les connexions indirectes
  repeat {
    buffer_exploitables <- st_buffer(tous_skidders_exploitables, dist = 5)
    connexion_indirecte <- st_intersects(skidders_non_connectes, buffer_exploitables, sparse = FALSE)
    
    nouveaux_exploitables <- skidders_non_connectes[rowSums(connexion_indirecte) > 0, ]
    
    if (nrow(nouveaux_exploitables) == 0) break
    
    tous_skidders_exploitables <- rbind(tous_skidders_exploitables, nouveaux_exploitables)
    skidders_non_connectes <- skidders_non_connectes[rowSums(connexion_indirecte) == 0, ]
  }
  
  # Intersection entre chemins exploitables et routes grumiers
  intersections <- st_intersection(tous_skidders_exploitables, routes_grumiers)
  if (!inherits(intersections, "POINT")) {
    place_de_depot <- st_collection_extract(intersections, type = "POINT")
  } else {
    place_de_depot <- intersections
  }
  
  # Affichage de la carte des resultats
  carte <- tm_shape(cadastre_2154) +
    tm_borders(col = "black", lwd = 1) +
    tm_shape(routes_grumiers) + 
    tm_lines(col = "blue", lwd = 1.5) +
    tm_shape(tous_skidders_exploitables) + 
    tm_lines(col = "green", lwd = 1) +
    tm_shape(skidders_non_connectes) + 
    tm_lines(col = "red", lwd = 1) +
    tm_shape(routes_sentiers) + 
    tm_lines(col = "#808080", lwd = 1) +
    tm_shape(place_de_depot) + 
    tm_dots(col = "yellow", size = 0.1) + 
    tm_layout(legend.outside = TRUE, legend.position = c("left", "bottom"))
  
  print(carte)
  
  list(
    skidders_exploitables = tous_skidders_exploitables,
    skidders_non_exploitables = skidders_non_connectes,
    place_de_depot = place_de_depot
  )
}

## Fonction pour sauvegarder une couche dans un fichier geopackage ----
sauvegarder.couche <- function(donnees, chemin_fichier, nom_couche) {
  # Ecriture de la couche dans un geopackage
  st_write(donnees, chemin_fichier, layer = nom_couche, delete_layer = TRUE)
}

## Fonction principale pour le traitement des donnees ----
obtention.desserte <- function(code_insee) {
  # Importation et reprojection des donnees cadastrales
  cadastre <- importer.cadastre(code_insee)
  cadastre_2154 <- reprojeter.donnees(cadastre, 2154)
  
  # Creation d'une zone tampon autour des parcelles cadastrales
  zone_tampon <- st_buffer(cadastre_2154, dist = 1000)
  
  # importation des routes intersectant la zone tampon
  routes <- importer.routes(zone_tampon)
  routes_2154 <- reprojeter.donnees(routes, 2154)
  
  # Filtrage des routes par type
  routes_filtrees <- filtrer.routes(routes_2154)
  
  # Verification de l'exploitabilite des pistes
  resultats_exploitabilite <- verifier.exploitabilite(
    routes_filtrees$routes_skidders,
    routes_filtrees$routes_grumiers,
    routes_filtrees$routes_sentiers,
    cadastre_2154
  )
  
  # Sauvegarde des resultats dans un fichier geopackage
  chemin_gpkg <- "exploitabilite_desserte.gpkg"
  couches_a_sauvegarder <- list(
    "cadastre" = cadastre_2154,
    "troncons_routes" = routes_2154,
    "sentiers" = routes_filtrees$routes_sentiers,
    "routes_grumiers" = routes_filtrees$routes_grumiers,
    "chemins_exploitables" = resultats_exploitabilite$skidders_exploitables,
    "chemins_non_exploitables" = resultats_exploitabilite$skidders_non_exploitables,
    "place_de_depot" = resultats_exploitabilite$place_de_depot
  )
  
  # Sauvegarde de chaque couche dans le geopackage
  for (nom_couche in names(couches_a_sauvegarder)) {
    sauvegarder.couche(couches_a_sauvegarder[[nom_couche]], chemin_gpkg, nom_couche)
  }
  
  print("Toutes les couches ont ete sauvegardees dans le fichier GeoPackage.")
}

# Exemple d'appel de la fonction principale
obtention.desserte("74261")


